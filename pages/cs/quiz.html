<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i ki·ªÉm tra CS - Crush Room Wiki</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/quiz/quiz-player.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üìö Crush Room Wiki</h2>
            </div>

            <nav class="sidebar-nav">
                <h3>Customer Service</h3>
                <a href="library.html">üìñ CS Training</a>
                <a href="quiz.html" class="active">‚úèÔ∏è B√†i ki·ªÉm tra</a>
                <a href="quick-replies.html">üí¨ Quick Replies</a>

                <h3>Kh√°c</h3>
                <a href="../../index.html">üè† Trang ch·ªß</a>
            </nav>

            <div class="sidebar-footer" id="authUI">
                <!-- Rendered by auth.js -->
            </div>
        </aside>

        <main class="main-content">
            <div class="breadcrumb">
                <a href="../../index.html">Trang ch·ªß</a>
                <span>/</span>
                <a href="library.html">CS Training</a>
                <span>/</span>
                <span>B√†i ki·ªÉm tra</span>
            </div>

            <!-- Quiz Container - Will be dynamically filled -->
            <div id="quiz-container">
                <div class="quiz-instructions">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚è≥</div>
                        <h2>ƒêang t·∫£i b√†i ki·ªÉm tra...</h2>
                        <p style="color: #757575;">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../js/auth.js"></script>
    <script src="../../js/quiz/quiz-engine.js?v=1.1"></script>
    <script src="../../js/quiz/quiz-renderer.js?v=1.1"></script>
    <script src="../../js/quiz/quiz-storage.js?v=1.1"></script>

    <script>
        /**
         * Quiz Initialization Script
         * Initializes and runs the quiz player
         */
        (async function() {
            // ============================================
            // 1. Authentication Check
            // ============================================
            if (!Auth.requireAuth()) {
                document.getElementById('quiz-container').innerHTML = `
                    <div class="quiz-instructions">
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
                            <h2>Y√™u c·∫ßu ƒëƒÉng nh·∫≠p</h2>
                            <p style="color: #757575;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l√†m b√†i ki·ªÉm tra</p>
                            <a href="../../login.html" class="btn btn-primary" style="margin-top: 20px;">
                                ƒêƒÉng nh·∫≠p ngay
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            if (!Auth.requirePermission('cs')) {
                document.getElementById('quiz-container').innerHTML = `
                    <div class="quiz-instructions">
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">‚õî</div>
                            <h2>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</h2>
                            <p style="color: #757575;">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p CS Training</p>
                            <a href="../../index.html" class="btn btn-secondary" style="margin-top: 20px;">
                                ‚Üê Quay l·∫°i trang ch·ªß
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Render auth UI
            Auth.renderAuthUI();

            // ============================================
            // 2. Get Quiz ID from URL
            // ============================================
            const urlParams = new URLSearchParams(window.location.search);
            const moduleParam = urlParams.get('module');

            // Default to module 2 if not specified
            const moduleId = moduleParam || '2';
            const quizId = `module-${moduleId}-quiz`;

            console.log('üéØ Loading quiz:', quizId);

            // ============================================
            // 3. Initialize Quiz Engine
            // ============================================
            try {
                const engine = new QuizEngine(quizId);
                const renderer = new QuizRenderer(engine, 'quiz-container');

                // Load quiz data
                const initialized = await engine.initialize();

                if (!initialized) {
                    throw new Error('Failed to initialize quiz');
                }

                // Check prerequisites
                const prereqCheck = await engine.checkPrerequisites();

                if (!prereqCheck.passed) {
                    document.getElementById('quiz-container').innerHTML = `
                        <div class="quiz-instructions">
                            <div style="text-align: center; padding: 60px 20px;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                                <h2>Kh√¥ng th·ªÉ l√†m b√†i</h2>
                                <p style="color: #757575; max-width: 500px; margin: 20px auto;">
                                    ${prereqCheck.reason}
                                </p>
                                <a href="library.html" class="btn btn-primary" style="margin-top: 20px;">
                                    ‚Üê Quay l·∫°i th∆∞ vi·ªán
                                </a>
                            </div>
                        </div>
                    `;
                    return;
                }

                // ============================================
                // 4. Render Quiz Instructions
                // ============================================
                renderer.renderInstructions();

                console.log('‚úì Quiz ready to start');

            } catch (error) {
                console.error('‚úó Quiz initialization failed:', error);

                document.getElementById('quiz-container').innerHTML = `
                    <div class="quiz-instructions">
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">‚ùå</div>
                            <h2>L·ªói t·∫£i b√†i ki·ªÉm tra</h2>
                            <p style="color: #757575; max-width: 500px; margin: 20px auto;">
                                Kh√¥ng th·ªÉ t·∫£i b√†i ki·ªÉm tra. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.
                            </p>
                            <p style="color: #f44336; font-size: 0.9rem; margin-top: 12px;">
                                L·ªói: ${error.message}
                            </p>
                            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                                <button onclick="location.reload()" class="btn btn-primary">
                                    üîÑ Th·ª≠ l·∫°i
                                </button>
                                <a href="library.html" class="btn btn-secondary">
                                    ‚Üê Quay l·∫°i th∆∞ vi·ªán
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        })();

        // ============================================
        // Development Helper Functions
        // ============================================

        // Export results to CSV (for debugging)
        window.exportResults = function() {
            QuizStorage.downloadCSV('quiz_results_' + new Date().toISOString().slice(0,10) + '.csv');
        };

        // View statistics
        window.viewStats = function() {
            const stats = QuizStorage.getStatistics();
            console.log('üìä Quiz Statistics:', stats);
            alert(`üìä Th·ªëng k√™ Quiz:

T·ªïng s·ªë b√†i l√†m: ${stats.totalSubmissions}
S·ªë ng∆∞·ªùi l√†m: ${stats.uniqueUsers}
ƒêi·ªÉm trung b√¨nh: ${stats.averageScore}/10
T·ª∑ l·ªá ƒë·∫≠u: ${stats.passRate}
            `);
        };

        // Clear all quiz data (careful!)
        window.clearQuizData = function() {
            QuizStorage.clearAllData();
        };

        console.log('üí° Dev commands available:');
        console.log('  - exportResults() : Export quiz results to CSV');
        console.log('  - viewStats()     : View quiz statistics');
        console.log('  - clearQuizData() : Clear all local quiz data');
    </script>
</body>
</html>
